name: Test and Publish

on:
  workflow_dispatch:
  push:
    branches: [main]
    paths:
      - "**/resources/**"
      - Dockerfile
  pull_request:
    paths:
      - "**/workflows/**"
      - "**/resources/**"
      - Dockerfile

permissions:
  contents: read
  packages: write
  id-token: write

concurrency:
  group: ${{ github.workflow }}-${{ github.job }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

jobs:
  # Define a job that sets up the matrix configuration
  matrix-config:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      odoo-versions: ${{ steps.set-matrix.outputs.odoo-versions }}
    steps:
      - id: set-matrix
        run: |
          # Properly escape the JSON for GitHub Actions
          echo 'matrix={"odoo_version":["15.0","16.0","17.0","18.0","master"],"include":[{"odoo_version":"15.0","python_version":"3.12","python_variant":"slim-bullseye","wkhtmltox_version":"0.12.6.1-3"},{"odoo_version":"16.0","python_version":"3.12","python_variant":"slim-bookworm","wkhtmltox_version":"0.12.6.1-3"},{"odoo_version":"17.0","python_version":"3.12","python_variant":"slim-bookworm","wkhtmltox_version":"0.12.6.1-3"},{"odoo_version":"18.0","python_version":"3.12","python_variant":"slim-bookworm","wkhtmltox_version":"0.12.6.1-3"},{"odoo_version":"master","python_version":"3.12","python_variant":"slim-bookworm","wkhtmltox_version":"0.12.6.1-3"}]}' >> $GITHUB_OUTPUT
          echo 'odoo-versions=["15.0","16.0","17.0","18.0","master"]' >> $GITHUB_OUTPUT

  build:
    needs: matrix-config
    name: Build Odoo ${{ matrix.odoo_version }}
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.matrix-config.outputs.matrix) }}
    uses: ./.github/workflows/image-builder.yaml
    with:
      odoo_version: ${{ matrix.odoo_version }}
      python_version: ${{ matrix.python_version }}
      python_variant: ${{ matrix.python_variant }}
      wkhtmltox_version: ${{ matrix.wkhtmltox_version }}
      dockerfile_path: Dockerfile
      dockerfile_target: production
    secrets: inherit

  test:
    needs: [matrix-config, build]
    strategy:
      fail-fast: false
      matrix:
        odoo_version: ${{ fromJson(needs.matrix-config.outputs.odoo-versions) }}
    uses: ./.github/workflows/unit-tests.yaml
    with:
      odoo_version: ${{ matrix.odoo_version }}
    secrets: inherit

  publish:
    needs: [matrix-config, build, test]
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.matrix-config.outputs.matrix) }}
    uses: ./.github/workflows/image-builder.yaml
    if: ${{ github.event_name != 'pull_request' }}
    with:
      odoo_version: ${{ matrix.odoo_version }}
      python_version: ${{ matrix.python_version }}
      python_variant: ${{ matrix.python_variant }}
      wkhtmltox_version: ${{ matrix.wkhtmltox_version }}
      dockerfile_path: Dockerfile
      dockerfile_target: production
    secrets: inherit
